/**
 * Created by Milos Roksandic on 22.5.16..
 */
!function(t,e){function i(){var e=t.editors.TextEditor.prototype.extend();e.prototype.bindEvents=function(){this.eventManager.addEventListener(this.TEXTAREA,"keydown",function(e){e.which==t.helper.KEY_CODES.ENTER&&t.Dom.stopImmediatePropagation(e)})},t.editors.ExcelMultilineEditor=e,t.editors.registerEditor("wdt.text_multiline",e)}function o(){var e=t.editors.DateEditor.prototype.extend();e.prototype.init=function(){t.editors.DateEditor.prototype.init.apply(this,arguments);var e=this.instance.getSettings();this.same_display_and_edit_format=e.dataSourceDateFormat==e.displayDateFormat},e.prototype.onBeforeKeyDown=function(e){switch(e.keyCode){case t.helper.KEY_CODES.ESCAPE:var i=this.getActiveEditor();i.finishEditing(!0)}},e.prototype.discardEditor=function(e){t.editors.DateEditor.prototype.discardEditor.apply(this,arguments);var i=this.instance,o=i.getCellMeta(this.row,this.col).allowInvalid;o||e||this.$datePicker.isVisible()||(this.datePickerStyle.display="block",this.$datePicker.show())},e.prototype.open=function(){this.instance.addHook("beforeKeyDown",this.onBeforeKeyDown),t.editors.DateEditor.prototype.open.apply(this,arguments)},e.prototype.close=function(){t.editors.DateEditor.prototype.close.apply(this,arguments),this.instance.removeHook("beforeKeyDown",this.onBeforeKeyDown)},e.prototype.prepare=function(e,i,o,r,n,a){if(n&&"0000-00-00"!=n||(n=""),n&&!this.same_display_and_edit_format){var s=this.instance.getSettings();n=moment(n,s.dataSourceDateFormat).format(s.displayDateFormat)}t.editors.DateEditor.prototype.prepare.apply(this,arguments)},e.prototype.saveValue=function(e,i){if(e[0][0]&&!this.same_display_and_edit_format){var o=this.instance.getSettings();e[0][0]=moment(e[0][0],o.displayDateFormat).format(o.dataSourceDateFormat)}t.editors.DateEditor.prototype.saveValue.apply(this,arguments)},t.editors.ExcelDateEditor=e,t.editors.registerEditor("wdt.date",e)}function r(){var i=t.editors.BaseEditor.prototype.extend();i.prototype.init=function(){this.wdtCustomUploader=wp.media({title:wpdatatables_frontend_strings.select_upload_file,button:{text:wpdatatables_frontend_strings.choose_file},multiple:!1});var t=this,i=this.instance;this.wdtCustomUploader.on("select",function(){var e=t.wdtCustomUploader.state().get("selection").first().toJSON(),o=i.getCellRenderer(t.row,t.col).name,r=e.url;if("wdtImageRenderer"==o)if("image"!=e.type)r="";else{var n=new URI(r);if(n.setQuery({img_width:e.width,img_height:e.height}),r=n.toString(),e.sizes.thumbnail){var a=new URI(e.sizes.thumbnail.url);a.setQuery({img_width:e.sizes.thumbnail.width,img_height:e.sizes.thumbnail.height}),r=a.toString()+"||"+r}}i.setDataAtCell(t.row,t.col,r)}),$browseButton=e('<buttnon class="button-primary">'+wpdatatables_frontend_strings.browse_file+"</buttnon>"),e($browseButton).click(function(t){t.preventDefault(),i.getActiveEditor().wdtCustomUploader.open()}),this.BROWSE_BUTTON=$browseButton[0],this.INPUT_FILE_URL=e('<input type="hidden" />')[0],this.UPLOADED_FILES_ELEMENTS=document.createElement("p"),$editorCnt=e('<div class="wdtAttachmentEditorHolder" ></div>').append(this.UPLOADED_FILES_ELEMENTS,this.BROWSE_BUTTON,this.INPUT_FILE_URL).hide(),this.EDITOR_CONTENT=$editorCnt[0],this.editorContainerStyle=this.EDITOR_CONTENT.style,this.instance.rootElement.appendChild(this.EDITOR_CONTENT)},i.prototype.getValue=function(){return this.INPUT_FILE_URL.value},i.prototype.setValue=function(t){this.INPUT_FILE_URL.value=t;var i="",o=this.instance;if(""!=t){var i,r=t.split("||")[0];i="wdtImageRenderer"==o.getCellRenderer(this.row,this.col).name?e('<img src="'+r+'" />').css({"max-width":"100px","max-height":"50px"})[0].outerHTML:t.split("/").pop(),i+='<span class="delete_file">[<a href="#">'+wpdatatables_frontend_strings.detach_file+"</a>]</span>"}e(this.UPLOADED_FILES_ELEMENTS).html(i),e(this.UPLOADED_FILES_ELEMENTS).on("click","a",function(t){t.preventDefault(),t.stopImmediatePropagation();var e=o.getActiveEditor();e.setValue("",!1),e.finishEditing(!1,!1)})},i.prototype.open=function(){this.refreshDimensions()},i.prototype.close=function(){this.editorContainerStyle.display="none"},i.prototype.focus=function(){this.BROWSE_BUTTON.focus()},i.prototype.getEditedCell=function(){var t,e=this.checkEditorSection();switch(e){case"top":t=this.instance.view.wt.wtOverlays.topOverlay.clone.wtTable.getCell({row:this.row,col:this.col}),this.editorContainerStyle.zIndex=101;break;case"top-left-corner":t=this.instance.view.wt.wtOverlays.topLeftCornerOverlay.clone.wtTable.getCell({row:this.row,col:this.col}),this.editorContainerStyle.zIndex=103;break;case"bottom-left-corner":t=this.instance.view.wt.wtOverlays.bottomLeftCornerOverlay.clone.wtTable.getCell({row:this.row,col:this.col}),this.editorContainerStyle.zIndex=103;break;case"left":t=this.instance.view.wt.wtOverlays.leftOverlay.clone.wtTable.getCell({row:this.row,col:this.col}),this.editorContainerStyle.zIndex=102;break;case"bottom":t=this.instance.view.wt.wtOverlays.bottomOverlay.clone.wtTable.getCell({row:this.row,col:this.col}),this.editorContainerStyle.zIndex=102;break;default:t=this.instance.getCell(this.row,this.col),this.editorContainerStyle.zIndex=""}return-1!=t&&-2!=t?t:void 0},i.prototype.refreshDimensions=function(){if(this.state===t.EditorState.EDITING){if(this.TD=this.getEditedCell(),!this.TD)return void this.close(!0);var e,i=t.Dom.offset(this.TD),o=t.Dom.offset(this.instance.rootElement),r=t.Dom.getScrollableElement(this.TD),n=this.instance.countRows(),a=i.top-o.top-1-(r.scrollTop||0),s=i.left-o.left-1-(r.scrollLeft||0),l=this.instance.getSettings(),d=l.colHeaders?1:0,c=this.checkEditorSection();switch(c){case"top":e=t.Dom.getCssTransform(this.instance.view.wt.wtOverlays.topOverlay.clone.wtTable.holder.parentNode);break;case"left":e=t.Dom.getCssTransform(this.instance.view.wt.wtOverlays.leftOverlay.clone.wtTable.holder.parentNode);break;case"top-left-corner":e=t.Dom.getCssTransform(this.instance.view.wt.wtOverlays.topLeftCornerOverlay.clone.wtTable.holder.parentNode);break;case"bottom-left-corner":e=t.Dom.getCssTransform(this.instance.view.wt.wtOverlays.bottomLeftCornerOverlay.clone.wtTable.holder.parentNode);break;case"bottom":e=t.Dom.getCssTransform(this.instance.view.wt.wtOverlays.bottomOverlay.clone.wtTable.holder.parentNode)}(d&&0===this.instance.getSelected()[0]||l.fixedRowsBottom&&this.instance.getSelected()[0]===n-l.fixedRowsBottom)&&(a+=1),0===this.instance.getSelected()[1]&&(s+=1),e&&-1!=e?this.editorContainerStyle[e[0]]=e[1]:t.Dom.resetCssTransform(this.EDITOR_CONTENT),this.editorContainerStyle.top=a+"px",this.editorContainerStyle.left=s+"px";var h=(this.TD.offsetTop-this.instance.view.wt.wtOverlays.topOverlay.getScrollPosition(),this.TD.offsetLeft-this.instance.view.wt.wtOverlays.leftOverlay.getScrollPosition()),p=t.Dom.innerWidth(this.TD)-8,u=this.instance.view.maximumVisibleElementWidth(h)-9;this.TD.scrollHeight+1;this.editorContainerStyle.width=p+"px",this.editorContainerStyle.maxWidth=u+"px",this.editorContainerStyle.display="block"}},t.editors.ExcelAttachmentEditor=i,t.editors.registerEditor("wdt.attachment",i)}function n(){var e=t.editors.DropdownEditor.prototype.extend();e.confirmWdtDropdownCellValidate=function(t,e,i,o,r){var n=this.propToCol(o),a=this.getCellMeta(i,n);if(t&&"function"==typeof a.cell_validator){var s=!1;return a.cell_validator(e,function(t){return s=t}),s}return t},e.prototype.open=function(){t.editors.DropdownEditor.prototype.open.apply(this,arguments),this.instance.addHook("afterValidate",e.confirmWdtDropdownCellValidate)},e.prototype.close=function(){t.editors.DropdownEditor.prototype.close.apply(this,arguments),this.instance.removeHook("afterValidate",e.confirmWdtDropdownCellValidate)},t.editors.ExcelDropdownEditor=e,t.editors.registerEditor("wdt.dropdown",e)}function a(){var i=t.editors.ExcelDropdownEditor.prototype.extend();i.onBeforeKeyDown=function(e){switch(e.keyCode){case t.helper.KEY_CODES.ENTER:var o=this.getActiveEditor(),r=o.htEditor.getInstance(),n=r.getSelected();if(n){var a=r.getCell(n[0],n[1]);i.selectDropdownItem(a,r,o)}e.stopImmediatePropagation(),e.preventDefault()}},i.selectDropdownItem=function(t,i,o){var r=e(t),n=r.text();r.children("strong:first-child").length?r.html(n):r.html("<strong>"+n+"</strong>");var a=[];e(i.rootElement).find("td strong:first-child").each(function(){a.push(e(this).text())}),o.setValue(a.join())},i.prototype.open=function(){this.instance.addHook("beforeKeyDown",i.onBeforeKeyDown),t.editors.ExcelDropdownEditor.prototype.open.apply(this,arguments);var o=this.htEditor.getInstance(),r=this,n=o.getSettings();o.removeHook("afterRenderer",o.pluginHookBucket.afterRenderer.slice(-1)[0]),o.removeHook("afterOnCellMouseDown",n.afterOnCellMouseDown),o.updateSettings({afterRenderer:function(i,o,n,a,s){var l,d=this.getCellMeta(o,n).filteringCaseSensitive===!0,s=t.helper.stringify(s);s&&(l=d?e.inArray(s,r.query.split(",")):e.inArray(s.toLowerCase(),r.query.toLowerCase().split(",")),-1!=l&&(i.innerHTML=s.replace(s,"<strong>"+s+"</strong>")))},afterOnCellMouseDown:function(t,e,n){var a=this.getValue();void 0!==a&&i.selectDropdownItem(n,o,r),r.focus()}})},i.prototype.finishEditing=function(i,o){if(this.htEditor&&this.htEditor.isListening()&&this.instance.listen(),this.htEditor){var r=[];e(this.htEditor.getInstance().rootElement).find("td strong:first-child").each(function(){r.push(e(this).text())}),this.setValue(this.TEXTAREA.value)}return t.editors.TextEditor.prototype.finishEditing.apply(this,arguments)},i.prototype.close=function(){t.editors.ExcelDropdownEditor.prototype.close.apply(this,arguments),this.instance.removeHook("beforeKeyDown",i.onBeforeKeyDown)},t.editors.ExcelMultiSelectEditor=i,t.editors.registerEditor("wdt.multi-select",i)}function s(i,o,r,n,a,s,l){if(t.TextRenderer.apply(this,arguments),!s)return o;var d=s.split("||"),c=d[0];if(0==c.length)return o;var h=d.length>1?d[1]:c,p=i.getSettings(),u="wdt_link",f="";p.readOnly||(u+="_editable",f='title="ctrl+click to open hyperlink:'+c+'"'),e(o).html('<a class="'+u+'" href="'+c+'" target="_blank" '+f+">"+h+"</a>")}function l(i,o,r,n,a,s,l){if(t.TextRenderer.apply(this,arguments),!s)return o;var d=s.split("||"),c=d[0];if(0==c.length)return o;var h=d.length>1?d[1]:c,p=i.getSettings(),u="wdt_email",f="";p.readOnly||(u+="_editable",f='title="ctrl+click to send email to:'+c+'"'),e(o).html('<a class="'+u+'" href="mailto:'+c+'" '+f+">"+h+"</a>")}function d(e,i,o,r,n,a,s){if(t.TextRenderer.apply(this,arguments),!a)return i;var l=a.split("||"),d=l[0];if(0==d.length)return i;var c=new URI(d),h=c.query(!0),p=c.hasQuery("img_width")?h.img_width:0,u=c.hasQuery("img_height")?h.img_height:0,f="";p>0&&(f+="width:"+p+"px; "),u>0&&(f+="height:"+u+"px;"),f.length>0&&(f='style="'+f+'"');var w="";if(l.length>1&&""!=l[1]){var g=e.getSettings(),m="wdt_link",y="",E=new URI(l[1]);E.removeQuery(["img_width","img_height"]);var v=E.toString();g.readOnly||(m+="_editable",y='title="ctrl+click to open hyperlink:'+v+'"');var D='<img class="wpdt-thumb" src="'+d+'" '+f+" />";w='<a class="'+m+'" href="'+v+'" target="_blank" '+y+">"+D+"</a>"}else w='<img class="wpdt-thumb" src="'+d+'" '+f+" />";i.innerHTML=w}function c(i,o,r,n,a,s,l){if(!s||"0000-00-00"==s)return s="",e(o).html(s),t.AutocompleteRenderer(i,o,r,n,a,s,l),o;var d=i.getSettings();d.dataSourceDateFormat!=d.displayDateFormat&&(s=moment(s,d.dataSourceDateFormat).format(d.displayDateFormat)),t.AutocompleteRenderer(i,o,r,n,a,s,l)}function h(){t.renderers.registerRenderer("wdt.date",c),t.renderers.registerRenderer("wdt.link",s),t.renderers.registerRenderer("wdt.email",l),t.renderers.registerRenderer("wdt.image",d)}function p(){i(),o(),r(),n(),a()}function u(){t.wdtDateCell={editor:"wdt.date",validator:t.wdtDateValidator,renderer:"wdt.date"},t.wdtMultiSelectCell={editor:"wdt.multi-select",validator:t.wdtMultiSelectValidator,renderer:"text"},t.cellTypes["wdt.date"]=t.wdtDateCell,t.cellTypes["wdt.multi-select"]=t.wdtMultiSelectCell}var f=t.editors.BaseEditor.prototype.beginEditing;t.editors.BaseEditor.prototype.beginEditing=function(t,e){var i=this.instance.getSettings();if(i.wpDataTablesExcelPlugin&&"undefined"==typeof t&&!i.readOnly){var o=i.idColumnKey,r=this.instance.getDataAtRowProp(this.row,o),n=this.cellProperties.defaultValue;!r&&n&&(t=n)}f.apply(this,arguments)};var w=t.editors.BaseEditor.prototype.cancelChanges;t.editors.BaseEditor.prototype.cancelChanges=function(){var t=this.instance.getCellMeta(this.row,this.col);if(t.wpDataTablesExcelPlugin){var i=e(document.activeElement).closest("#"+this.instance.rootElement.id+" > div.invalid_editor_value").removeClass("invalid_editor_value");i.length>0&&i.tooltip("instance")&&i.tooltip("destroy");var o=this.instance.getCellValidator(this.row,this.col),r=this.instance.getDataAtCell(this.row,this.col);if(o){var n=!1;if("function"==typeof o?o.call(t,r,function(t){return n=t}):o instanceof RegExp&&(n=o.test(r)),n){var a=this.instance.getCell(this.row,this.col),s=e(a),l=t.invalidCellClassName;s.hasClass(l)&&s.removeClass(l)}}}w.apply(this,arguments)},t.wdtLinkValidator=function(t,e){null===t&&(t="");var i=!1;if(""==t)i=!0;else{var o=/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?(||.*)?$/i;i=o.test(t)}e(i)},t.wdtEmailValidator=function(t,e){null===t&&(t="");var i=!1;if(""==t)i=!0;else{var o=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+(||.*)?$/;i=o.test(t)}e(i)},t.wdtDateValidator=function(e,i){null===e&&(e=""),""==e?i(!0):t.DateValidator.call(this,e,i)},t.wdtMultiSelectValidator=function(t,e){var i=!0;if(null===t&&(t=""),this.source){for(var o=t.toLowerCase().split(","),r=this.source.join(",").toLowerCase().split(","),n=0;n<o.length;n++)if(-1==r.indexOf(o[n])){i=!1;break}}else t&&(i=!1);e(i)},p(),h(),u()}(Handsontable,jQuery),"undefined"==typeof wpDataTablesExcelOptions&&(window.wpDtExcelTables={}),function(t){t(function(){t("div.wpExcelTable").handsontable({wpDataTablesExcelPlugin:!0})})}(jQuery);